#!/usr/bin/perl -w
use strict;

=head1 NAME

ChangeLog.mak.in - build NMS v2/buildtools/ChangeLog.mak

=head1 DESCRIPTION

This script holds the list of source files in the v2 subdirectory
of the NMS CVS tree, and builds a Makefile segment to maintain
a local cache of the CVS log for each source file.

=cut

my @files = qw(

  src/formmail/FormMail.pl
  src/formmail/README
  src/formmail/EXAMPLES

  lib/CGI/NMS/Charset.pm
  lib/CGI/NMS/Validator.pm
  lib/CGI/NMS/Mailer.pm
  lib/CGI/NMS/Mailer/Sendmail.pm
  lib/CGI/NMS/Mailer/SMTP.pm
  lib/CGI/NMS/Script.pm
  lib/CGI/NMS/Script/FormMail.pm

  package/formmail_modules/Makefile
  package/formmail_modules/README.install
  package/formmail_modules/README.manifest

  package/formmail_compat/Makefile

  buildtools/ChangeLog.mak.in
  buildtools/tarballs
  buildtools/inline
  buildtools/cvs2cl

);

open MAKEFILE, ">ChangeLog.mak" or die "open: $!";
print MAKEFILE <<'END';
#
# This Makefile segment defines dependencies for keeping individual
# CVS log files of all source files in date on the local system,
# and for merging subsets of those files into changelogs for
# particular packages.
#
# This CVS log cache system is intended to allow changelogs to be
# built from the CVS log entries, without going to sourceforge for
# the CVS log for each source file more than once per source file
# change.
#
# Include this Makefile into a package Makefile to define the
# dependencies of the .pkg/ChangeLog file.
#
# Imports from environment:
#
#   NMS_WORKING_COPY: The full filesystem path to the root of a
#                     working copy against the NMS CVS tree.
#
# Imports from parent Makefile:
#
#   SOURCE_FILES:     A list of the source files who's CVS change
#                     logs should be merged into .pkg/ChangeLog,
#                     relative to the v2 subdirectory of the CVS
#                     tree.
#
# This file autogenerated from ChangeLog.mak.in, DO NOT EDIT
#

CHANGELOG_BASE = $(NMS_WORKING_COPY)/v2/.changelog

CHANGELOG_FILES = $(SOURCE_FILES:%=$(CHANGELOG_BASE)/%)

.pkg/ChangeLog: .pkg $(CHANGELOG_FILES)
	(cd $(CHANGELOG_BASE) && ../buildtools/cvs2cl_cat --revisions --stdout $(SOURCE_FILES)) >$@

END

foreach my $file (@files) {
    my $dir = $file;
    $dir =~ s#/[^/]+$##;

    print MAKEFILE <<END;

\$(CHANGELOG_BASE)/$file: \$(NMS_WORKING_COPY)/v2/$file
\tmkdir -p \$(NMS_WORKING_COPY)/v2/.changelog/$dir
\tcd \$(NMS_WORKING_COPY) && cvs log v2/$file >\$\@
\ttest -s \$\@ || (rm \$\@ ; false)
END

}

close MAKEFILE or die "close: $!";

